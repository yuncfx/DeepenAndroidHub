## 第8章 App网络优化

#### 8-1 网络优化从哪些纬度开展?

1. 网络优化介绍
   1. 网络优化的纬度：多维度
   2. 仅仅重视流量不够
   3. 网络流量的消耗值：精确
   4. 整体均值掩盖单点问题
   5. 网络相关监控：全面
   6. 粗粒度监控不能帮助我们发现、解决深层次问题
   7. 针对网络：最广泛使用的是抓包工具
2. 网络优化纬度
   1. 流量消耗
      1. 一段时间流量消耗的精准度量，网络类型、前后台
      2. 监控相关：用户流量消耗均值、异常率（消耗多、次数多）
      3. 完整链路全部监控（Request、Response），主动上报
   2. 网络请求质量
      1. 用户体验：请求速度、成功率
      2. 监控相关：请求时长、业务成功率、失败率、Top失败接口
   3. 其它
      1. 公司成本：带宽、服务器数、CDN
      2. 耗电
3. 网络优化误区
   1. 只关注流量消耗，忽略其它纬度
   2. 只关注均值、整体，忽视个体

#### 8-2 网络优化工具选择

1. Network Profiler
   1. 显示实时网络活动：发送、接收数据及连接数
   2. 需要启动高级分析
   3. 只支持HttpUrlConnection和OkHttp网络库
2. 抓包工具
   1. Charles
      1. 断电功能
      2. Map Local
      3. 弱网环境模拟
   2. Fiddler
   3. Wireshark
   4. TcpDump
3. Stetho
   1. 强大的应用调试桥，连接Android和Chrome
   2. 网络监控、视图查看、数据库查看、命令行扩展等

#### 8-3 精准获取流量消耗实战

1. 问题思考：如何判断App流量消耗偏高
   1. 绝对值看不出高低
   2. 对比竞品，相同Case对比流量消耗
2. 测试方案
   1. 设置：流量管理
   2. 抓包工具：只允许本App联网
   3. 可以解决大多数问题，但是线上场景线下可能遇不到
3. 线上线下流量获取
   1. 线上流量获取方案
      1. TrafficStats
         1. TrafficStats：API8以上重启以来的流量数据统计
         2. getUidRxBytes(int uid)指定Uid的接收流量
         3. getTotalTxBytes()总发送流量
         4. 无法获取某个时间段内的流量消耗
      2. NetworkStatsManager
         1. NetworkStatsManager：API23之后流量统计
         2. 可获取指定时间间隔内的流量信息
         3. 可获取不同网络类型下的消耗
4. 前台后台流量获取
   1. 难题：线上反馈App后台跑流量
   2. 只获取一个时间段的值不够全面
   3. App启动执行后台定时任务，获取间隔时间内流量，分别计算前后台流量，上报至APM后台，作为流量治理依据
   4. Executors执行定时任务
5. 评价
   1. 有一定误差，可接收范围内
   2. 结合精细化的流量异常报警针对性的解决后台跑流量

#### 8-4 网络请求流量优化实战

1. 使用网络的场景概述
   1. 数据：Api、资源包（升级包、H5、RN）、配置信息
   2. 图片：下载、上传
   3. 监控：APM相关、单点问题相关
2. 数据缓存
   1. 服务端返回加上过期时间，避免每次重新获取
   2. 节约流量且大幅提高数据访问速度，更好的用户体验
   3. OkHttp、Volley都有较好实践
   4. NoNetInterceptor
3. 增量数据更新
   1. 加上版本的概念，只传输有变化的数据
   2. 配置信息、省市区县等更新
4. 数据压缩
   1. Post请求Body使用GZip压缩
   2. 请求头压缩
   3. 图片上传之前必须压缩：使用Luban 
5. 优化发送频率和时机
   1. 合并网络请求、减少请求次数
   2. 性能日志上报：批量+特定场景上报
6. 图片相关
   1. 图片使用策略细化：优先缩略图
   2. 使用WebP格式图片

#### 8-5 网络请求质量优化实战

1. 质量指标
   1. 网络请求成功率
   2. 网络请求速度 
2. Http请求过程
   1. 请求到达运营商的DNS服务器并解析成对应的IP地址
   2. 创建连接，根据IP地址找到相应的服务器，发起一个请求
   3. 服务器找到对应的资源原路返回访问给用户
3. DNS相关
   1. 问题：DNS被劫持、DNS解析慢
   2. 方案：使用HttpDNS，绕过运营商域名解析过程
   3. 优势：降低平均访问时长、提高连接成功率
   4. OkHttpDNS：使用阿里云提供的DNS解析服务
4. 协议版本升级
   1. 1.0：版本TCP连接不复用
   2. 1.1：引入持久连接，但数据通讯按次序进行
   3. 2：多工，客户端、服务器双向实时通信
5. 网络请求质量监控
   1. 接口请求耗时、成功率、错误码
   2. 图片加载的每一步耗时：Fresco有自带的监听
   3. 耗时监听OkHttpEventListener和统计对象OkHttpEvent
6. 网络容灾机制
   1. 备用服务器分流
   2. 多次失败后一定时间内不进行请求，避免雪崩效应
7. 其它
   1. CDN加速、提高带宽、动静资源分离（更新后清理缓存）
   2. 减少传输量，注意请求时机及频率

#### 8-6 网络体系化方案建设

1. 线下测试相关
   1. 方案：只抓单独App
   2. 侧重点：请求有误、多余，网络切换、弱网、无网测试
2. 线上监控相关
   1. 服务端监控
      1. 请求耗时（区分地域、时间段、版本、机型）
      2. 失败率（业务失败与请求失败）
      3. Top失败接口、异常接口统计
   2. 客户端监控
      1. 接口的每一步详细信息（DNS、连接、请求等）
      2. 请求次数、网络包大小、失败原因
      3. 图片监控
3. 异常监控体系
   1. 服务器防刷：超限拒绝访问
   2. 客户端：大文件预警、异常兜底策略
   3. 单点问题追查

#### 8-7 网络优化模拟面试

1. 在网络方面你们做了哪些监控，建立了哪些指标
   1. 演进过程、优化背景
      1. App初期没有注意到问题
      2. 用户增多，用户反馈，没办法确认问题
   2. 质量监控：请求成功率、每步耗时、状态码
   3. 流量：精确统计、前后台
2. 如何有效的降低用户流量消耗
   1. 数据：缓存、增量更新
   2. 上传：压缩
   3. 图片：缩略图、WebP格式使用
3. 用户反馈消耗流量多这种问题怎么查
   1. 精准流量获取能力
   2. 所有请求大小及次数的监控
   3. 主动预警能力